import Cookies from 'js-cookie';
import { crypto_currencies_display_order, fiat_currencies_display_order } from '@/components/shared';
import { generateDerivApiInstance } from '@/external/bot-skeleton/services/api/appId';
import { observer as globalObserver } from '@/external/bot-skeleton/utils/observer';
import useTMB from '@/hooks/useTMB';
import { clearAuthData } from '@/utils/auth-utils';
import { Callback } from '@deriv-com/auth-client';
import { Button } from '@deriv-com/ui';

/**
 * Gets the selected currency or falls back to appropriate defaults
 */
const getSelectedCurrency = (
    tokens: Record<string, string>,
    clientAccounts: Record<string, { loginid: string; token: string; currency: string }>,
    state: { account?: string } | null
): string => {
    const getQueryParams = new URLSearchParams(window.location.search);
    const currency =
        (state && state?.account) ||
        getQueryParams.get('account') ||
        sessionStorage.getItem('query_param_currency') ||
        '';
    const firstAccountKey = tokens.acct1;
    const firstAccountCurrency = clientAccounts[firstAccountKey]?.currency;

    const validCurrencies = [...fiat_currencies_display_order, ...crypto_currencies_display_order];
    if (tokens.acct1?.startsWith('VR') || currency === 'demo') return 'demo';
    if (currency && validCurrencies.includes(currency.toUpperCase())) return currency;
    return firstAccountCurrency || 'USD';
};

const CallbackPage = () => {
    return (
        <Callback
            onSignInSuccess={async (tokens: Record<string, string>, rawState: unknown) => {
                const state = rawState as { account?: string } | null;
                const accountsList: Record<string, string> = {};
                const clientAccounts: Record<string, any> = {};

                for (const [key, value] of Object.entries(tokens)) {
                    if (key.startsWith('acct')) {
                        const tokenKey = key.replace('acct', 'token');
                        if (tokens[tokenKey]) {
                            accountsList[value] = tokens[tokenKey];
                            clientAccounts[value] = {
                                loginid: value,
                                token: tokens[tokenKey],
                                currency: '',
                            };
                        }
                    } else if (key.startsWith('cur')) {
                        const accKey = key.replace('cur', 'acct');
                        if (tokens[accKey] && clientAccounts[tokens[accKey]]) {
                            clientAccounts[tokens[accKey]].currency = value;
                        }
                    }
                }

                localStorage.setItem('accountsList', JSON.stringify(accountsList));
                localStorage.setItem('clientAccounts', JSON.stringify(clientAccounts));

                let is_token_set = false;

                const api = await generateDerivApiInstance();
                if (api) {
                    const { authorize, error } = (await api.authorize(tokens.token1)) as any;
                    api.disconnect();
                    if (error) {
                        // Check if the error is due to an invalid token
                        if (error.code === 'InvalidToken') {
                            // Set is_token_set to true to prevent the app from getting stuck in loading state
                            is_token_set = true;

                            // Only emit the InvalidToken event if logged_state is true
                            const { is_tmb_enabled = false } = useTMB();
                            if (Cookies.get('logged_state') === 'true' && !is_tmb_enabled) {
                                // Emit an event that can be caught by the application to retrigger OIDC authentication
                                globalObserver.emit('InvalidToken', { error });
                            }
                            if (Cookies.get('logged_state') === 'false') {
                                // If the user is not logged out, we need to clear the local storage
                                clearAuthData();
                            }
                        }
                    } else if (authorize) {
                        localStorage.setItem('callback_token', JSON.stringify(authorize));
                        localStorage.setItem('active_loginid', authorize.loginid);
                        localStorage.setItem('authToken', tokens.token1);
                        localStorage.setItem('client.country', authorize.country);

                        // Update accounts list and details from authorize response
                        authorize.account_list.forEach((acc: any) => {
                            const token = accountsList[acc.loginid] || tokens.token1;
                            accountsList[acc.loginid] = token;
                            clientAccounts[acc.loginid] = {
                                ...acc,
                                token,
                            };
                        });

                        localStorage.setItem('accountsList', JSON.stringify(accountsList));
                        localStorage.setItem('clientAccounts', JSON.stringify(clientAccounts));
                        is_token_set = true;
                    }
                }

                if (!is_token_set) {
                    localStorage.setItem('authToken', tokens.token1);
                    localStorage.setItem('active_loginid', tokens.acct1);
                }

                // Set logged_state cookie
                const domain = window.location.hostname.includes('deriv.com') ? '.deriv.com' : undefined;
                Cookies.set('logged_state', 'true', {
                    expires: 30,
                    path: '/',
                    domain: domain,
                    secure: true,
                    sameSite: 'lax',
                });
                // Determine the appropriate currency to use
                const selected_currency = getSelectedCurrency(tokens, clientAccounts, state);

                const redirect_url = sessionStorage.getItem('redirect_url');
                if (redirect_url) {
                    const url = new URL(redirect_url);
                    url.searchParams.set('account', selected_currency);
                    sessionStorage.removeItem('redirect_url');
                    window.location.replace(url.toString());
                } else {
                    window.location.replace(window.location.origin + `/?account=${selected_currency}`);
                }
            }}
            renderReturnButton={() => {
                return (
                    <Button
                        className='callback-return-button'
                        onClick={() => {
                            window.location.href = '/';
                        }}
                    >
                        {'Return to Bot'}
                    </Button>
                );
            }}
        />
    );
};

export default CallbackPage;
